# アプリケーション仕様書

## 1. 概要

本アプリケーションは、動画ファイルからテキストベースのドキュメント（マニュアルまたは仕様書）を自動生成するデスクトップアプリケーションである。GoogleのGemini Pro APIを活用し、macOSおよびWindows上で動作する。

## 2. 機能要件

### 2.1. コア機能

- ユーザーは、ローカルから複数の動画ファイル（例: .mp4, .mov）を選択できる。
- 選択された動画を基に、テキストドキュメントを生成する。
- 生成するドキュメントの種類は「マニュアルモード」と「仕様書モード」から選択できる。
- 生成するドキュメントの言語を「日本語」または「英語」から選択できる。

### 2.2. モード設定

アプリケーションの設定画面にて、以下の項目を設定できる。

- **ドキュメントモード**:
    - **マニュアル作成モード**: 動画の内容を手順や操作方法として解説する形式のドキュメントを生成する。
    - **仕様書作成モード**: 動画の内容を機能や動作の仕様として記述する形式のドキュメントを生成する。
- **出力言語**: 日本語 / 英語
- **Gemini APIキー**: API連携に利用するキー。

### 2.3. プロンプト設定

アプリケーションには、ドキュメント生成時に使用するプロンプトを管理する機能がある。

- **プロンプトプリセット管理**:
    - カスタムプロンプトプリセットの作成・編集・削除
    - デフォルトプリセットの利用（編集・削除不可）
    - プリセットの一覧表示と選択機能
    - 起動時にデフォルトプリセットが存在しない、または破損している場合に自動で修復
- **プロンプトのインポート・エクスポート**:
    - XML形式でのプリセットのエクスポート機能
    - XML形式からのプリセットのインポート機能（IDが重複した場合は自動でユニークなIDを付与）
- **リアルタイムプロンプト編集**:
    - 選択したプリセットを基にしたプロンプトの編集
    - 生成処理での編集済みプロンプトの適用

### 2.4. 動画処理

- **ファイル選択**: 複数の動画ファイルを同時に選択し、処理対象とすることができる。
- **外部ツール連携**: `ffmpeg`および`ffprobe`の実行ファイルを、一般的なインストールパス（Homebrew等）および環境変数`PATH`から自動で探索する。
- **長時間動画の分割**: 1時間を超える動画ファイルが入力された場合、ffprobeで動画の長さを判定し、ffmpegを使用して1時間未満のセグメントに自動で分割する。
- **API連携**:
    - **アップロード**: 動画ファイルはGemini APIのFile API（v1beta）を利用して、再開可能アップロード（Resumable Upload）方式でアップロードする。アップロード中は進捗をポーリングし、UIに表示する。
    - **ドキュメント生成**: `gemini-2.5-pro-latest` モデルに対してドキュメント生成をリクエストする。
- **ドキュメント統合**: 複数の動画ファイルや分割されたセグメントから生成されたドキュメントを、最終的に `gemini-2.5-pro-latest` モデルを利用して1つのまとまったドキュメントとして統合し、ユーザーに提示する。
- **進捗表示**: ファイル処理、アップロード、ドキュメント生成、統合の各ステップで詳細な進捗状況（例：「ファイルアップロード中 (1/3)」）をUIにリアルタイムで通知し、詳細な処理ログも表示する。

### 2.5. 画像埋め込み機能

- **画像埋め込みオプション**:
    - UI上に「ドキュメントに画像を埋め込む」オプション（チェックボックス）を設ける。
    - このオプションが有効な場合、生成されるドキュメントに動画のスクリーンショットが埋め込まれる。
- **プロンプトへの指示追加**:
    - 画像埋め込みオプションが有効な場合、Geminiへのリクエスト時に、視覚的な説明が必要な箇所で動画の経過秒数を特定の書式（例: `[Screenshot: 123.45s]`)で出力するよう自動的に指示を追加する。
- **画像生成と埋め込み**:
    - Geminiの出力から秒数指定のプレースホルダーを正規表現で抽出する。
    - 抽出された各秒数に基づき、`ffmpeg` を使用して動画からフレームを画像ファイル（例: PNG形式）として書き出す。
    - 画像は、出力ドキュメントと同じ階層に作成される `images` フォルダ内に連番（例: `image-01.png`)で保存される。
    - ドキュメント内のプレースホルダーを、生成した画像への相対パスを持つMarkdownの画像タグ（例: `![Screenshot 1](./images/image-01.png)`)に置換する。
- **エラーハンドリング**:
    - `ffmpeg` の実行に失敗した場合や、指定された秒数が不正な場合は、処理をスキップし、ログにエラーを記録する。対象のプレースホルダーはドキュメントから削除される。

## 3. 技術仕様

- **フレームワーク**: Tauri
- **言語**:
    - フロントエンド: TypeScript, React
    - バックエンド: Rust
- **外部API**: Google Gemini API
- **外部ライブラリ/プラグイン**:
    - ffmpeg, ffprobe（動画処理用）
    - `tauri-plugin-dialog`, `tauri-plugin-opener`（ネイティブUI連携用）
    - `which`（実行ファイル探索用）
    - `base64`, `serde`, `serde_json`（データ処理用）
- **対応プラットフォーム**:
    - Windows
    - macOS
- **対応動画形式**:
    - `mp4`, `mpeg`, `mov`, `avi`, `x-flv`, `mpg`, `webm`, `wmv`, `3gpp`, `mkv`

### 3.1. バックエンドモジュール構造

Rustバックエンドは機能別にモジュール化され、保守性と可読性を向上させている。

#### 3.1.1. モジュール一覧

- **`lib.rs`** - メインライブラリファイル
  - Tauriコマンドの定義とアプリケーション設定
  - モジュール間の調整とイベント処理（詳細な進捗通知を含む）
  - アプリケーション起動時の初期化処理
  - 設定（APIキー暗号化含む）およびプロンプトプリセットの読み書きと堅牢な管理
  - 画像埋め込みオプションに応じた処理の振り分け

- **`types.rs`** - 型定義モジュール
  - `VideoFile` - 動画ファイル情報の構造体
  - `AppSettings` - アプリケーション設定の構造体
  - `ProgressUpdate` - 進捗更新情報の構造体
  - `PromptPreset` - プロンプトプリセット情報の構造体
  - `Gemini*` - Gemini API関連の型定義群

- **`file.rs`** - ファイル操作モジュール
  - `select_video_files()` - 動画ファイル選択ダイアログ
  - `select_save_directory()` - 保存先ディレクトリ選択ダイアログ
  - `save_document_to_file()` - ドキュメントファイル保存処理

- **`gemini.rs`** - Gemini API連携モジュール
  - `upload_to_gemini_with_progress()` - 進捗付きファイルアップロード
  - `generate_with_gemini_with_progress()` - 進捗付きドキュメント生成
  - `integrate_documents()` - 複数ドキュメントの統合処理
  - `get_mime_type()` - ファイル形式判定ヘルパー
  - 画像埋め込み指示のプロンプト挿入、レスポンス内の秒数プレースホルダーの解析とMarkdown画像タグへの置換

- **`video.rs`** - 動画処理モジュール
  - `find_executable()` - ffmpeg/ffprobe実行ファイルのパスを探索
  - `split_video_if_needed()` - 長時間動画の自動分割（1時間超の場合）
  - `get_video_duration()` - ffprobeによる動画時間取得
  - `extract_frame_from_video()` - 指定された秒数のフレームを画像として抽出

#### 3.1.2. モジュール間の依存関係

```
lib.rs
├── types.rs （型定義を参照）
├── file.rs （ファイル操作を呼び出し）
├── gemini.rs （API処理を呼び出し）
└── video.rs （動画処理を呼び出し）

gemini.rs → types.rs （型定義を参照）
file.rs → types.rs （VideoFile型を参照）
video.rs → 独立モジュール
```

#### 3.1.3. 設計原則

- **単一責任の原則**: 各モジュールは特定の機能領域のみを担当
- **疎結合**: モジュール間の依存を最小限に抑制
- **型安全性**: 共通の型定義により型安全性を確保
- **エラーハンドリング**: anyhow::Resultによる統一的なエラー処理

### 3.2. フロントエンドモジュール構造

Reactフロントエンドは、保守性と可読性を向上させるために画面毎に機能分割されている。

#### 3.2.1. モジュール一覧

- **`src/App.tsx`** - メインアプリケーションコンポーネント
  - 画面状態管理（API設定、プロンプト設定、メインダッシュボード）
  - 各画面コンポーネント間のルーティング
  - 共通の状態管理とイベントハンドリング

- **`src/types.ts`** - 型定義モジュール
  - `DocumentMode` - ドキュメント生成モードの型定義
  - `VideoFile` - 動画ファイル情報の構造体
  - `AppSettings` - アプリケーション設定の構造体
  - `PromptPreset` - プロンプトプリセット情報の構造体
  - `ProgressUpdate` - 進捗更新情報の構造体

- **`src/utils/fileUtils.ts`** - ファイル操作ユーティリティ
  - `formatFileSize()` - ファイルサイズのフォーマット処理
  - `generateFilename()` - 生成ファイル名の自動作成

- **`src/hooks/useLogger.ts`** - ログ機能カスタムフック
  - `addLog()` - ログエントリの追加
  - `clearLogs()` - ログのクリア
  - ログコンテナーの自動スクロール機能

- **`src/components/ApiSettings.tsx`** - API設定画面コンポーネント
  - Gemini APIキーの設定
  - 設定の保存・キャンセル機能

- **`src/components/PromptSettings.tsx`** - プロンプト設定画面コンポーネント
  - プロンプトプリセットの一覧表示
  - プリセットの編集・削除機能
  - XML形式でのプリセットのインポート・エクスポート

- **`src/components/PresetEditModal.tsx`** - プリセット編集モーダル
  - プリセットの新規作成・編集機能
  - モーダルダイアログによるUI

- **`src/components/MainDashboard.tsx`** - メインダッシュボード
  - 動画ファイル選択・管理
  - ドキュメント生成設定
  - 画像埋め込みオプションのUIと状態管理
  - 進捗状況の表示
  - 生成結果の表示

#### 3.2.2. コンポーネント間の依存関係

```
App.tsx (メインコンポーネント)
├── types.ts （型定義を参照）
├── utils/fileUtils.ts （ユーティリティ関数を使用）
├── hooks/useLogger.ts （ログ機能を使用）
├── components/ApiSettings.tsx （API設定画面）
├── components/PromptSettings.tsx （プロンプト設定画面）
├── components/PresetEditModal.tsx （プリセット編集モーダル）
└── components/MainDashboard.tsx （メインダッシュボード）

各コンポーネント → types.ts （型定義を参照）
MainDashboard.tsx → utils/fileUtils.ts （ユーティリティ関数を使用）
```

#### 3.2.3. 設計原則

- **コンポーネント分離**: 各画面を独立したコンポーネントとして分離
- **Propsによる疎結合**: 親コンポーネントからのpropsで状態を管理
- **カスタムフック**: 共通機能（ログ管理等）をカスタムフックで抽象化
- **型安全性**: TypeScriptによる厳密な型チェック
- **単一責任**: 各コンポーネントは特定の画面機能のみを担当

## 4. 画面構成

アプリケーションは以下の画面で構成されている。

### 4.1. メインダッシュボード画面

- **ヘッダー**:
    - アプリケーションタイトル
    - API設定ボタン
    - プロンプト設定ボタン
- **ドキュメント設定セクション**:
    - ドキュメントモード選択（マニュアル作成 / 仕様書作成）
    - 出力言語選択（日本語 / 英語）
    - 画像埋め込みオプション（チェックボックス）
- **プロンプト設定セクション**:
    - プリセット選択ドロップダウン
    - 現在のプロンプト編集エリア
- **ファイル選択セクション**:
    - ファイル選択ボタン
    - 選択されたファイルリスト（ファイル名、サイズ、削除ボタン）
- **保存設定セクション**:
    - 保存先ディレクトリ選択ボタン
    - 保存先パス表示
    - 生成ファイル名プレビュー
- **生成セクション**:
    - ドキュメント生成ボタン
    - 進捗表示（プログレスバー、メッセージ）
    - 処理ログ表示（表示/非表示切り替え、クリア機能）
- **結果表示セクション**:
    - 生成されたドキュメント内容
    - 再保存ボタン

### 4.2. API設定画面

- **設定フォーム**:
    - Gemini APIキー入力欄（パスワード形式）
    - 保存ボタン
    - キャンセルボタン

### 4.3. プロンプト設定画面

- **プリセット管理セクション**:
    - プリセット一覧表示
        - プリセット名とプレビュー
        - デフォルトバッジ表示
        - 編集・削除ボタン（デフォルトプリセット以外）
    - 新規プリセット作成ボタン
    - XMLインポート・エクスポートボタン
- **プリセット編集モーダル**:
    - プリセット名入力欄
    - プロンプト内容編集エリア
    - 保存・キャンセルボタン
- **削除確認モーダル**:
    - 削除対象プリセット名表示
    - 警告メッセージ
    - 削除実行・キャンセルボタン

## 5. 非機能要件

- **パフォーマンス**: 大容量の動画ファイルでも安定して動作すること。
- **UI/UX**: 直感的で分かりやすいインターフェイスを提供する。
- **セキュリティ**: APIキーは、固定キーを用いたXOR暗号化およびBase64エンコードを施した上で、OS標準のアプリケーション設定ディレクトリ内の`settings.json`に保存される。復号に失敗した際は、後方互換性のため元の文字列をそのまま返す。
