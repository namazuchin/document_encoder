# アプリケーション仕様書

## 1. 概要

本アプリケーションは、動画ファイルからテキストベースのドキュメント（マニュアルまたは仕様書）を自動生成するデスクトップアプリケーションである。GoogleのGemini Pro APIを活用し、macOSおよびWindows上で動作する。

## 2. 機能要件

### 2.1. コア機能

- ユーザーは、ローカルから複数の動画ファイル（例: .mp4, .mov）を選択できる。
- 選択された動画を基に、テキストドキュメントを生成する。
- 生成するドキュメントの種類は「マニュアルモード」と「仕様書モード」から選択できる。
- 生成するドキュメントの言語を「日本語」または「英語」から選択できる。

### 2.2. モード設定

アプリケーションの設定画面にて、以下の項目を設定できる。

- **ドキュメントモード**:
    - **マニュアル作成モード**: 動画の内容を手順や操作方法として解説する形式のドキュメントを生成する。
    - **仕様書作成モード**: 動画の内容を機能や動作の仕様として記述する形式のドキュメントを生成する。
- **出力言語**: 日本語 / 英語
- **Gemini APIキー**: API連携に利用するキー。

### 2.3. 動画処理

- **ファイル選択**: 複数の動画ファイルを同時に選択し、処理対象とすることができる。
- **長時間動画の分割**: 1時間を超える動画ファイルが入力された場合、ffprobeで動画の長さを判定し、ffmpegを使用して1時間未満のセグメントに自動で分割する。
- **API連携**:
    - **アップロード**: 動画ファイルはGemini APIのFile API（v1beta）を利用して、再開可能アップロード（Resumable Upload）方式でアップロードする。アップロード中は進捗をポーリングし、UIに表示する。
    - **ドキュメント生成**: アップロード後、`gemini-2.5-pro-preview-06-05` モデルに対してドキュメント生成をリクエストする。
- **ドキュメント統合**: 複数の動画ファイルや分割されたセグメントから生成されたドキュメントを、最終的に `gemini-2.5-pro` モデルを利用して1つのまとまったドキュメントとして統合し、ユーザーに提示する。
- **進捗表示**: ファイル処理、アップロード、ドキュメント生成、統合の各ステップで進捗状況をUIに通知し、詳細な処理ログも表示する。

## 3. 技術仕様

- **フレームワーク**: Tauri
- **言語**:
    - フロントエンド: TypeScript, React
    - バックエンド: Rust
- **外部API**: Google Gemini API
- **外部ライブラリ**:
    - ffmpeg, ffprobe（動画処理用）
- **対応プラットフォーム**:
    - Windows
    - macOS
- **対応動画形式**:
    - `mp4`, `mpeg`, `mov`, `avi`, `x-flv`, `mpg`, `webm`, `wmv`, `3gpp`, `mkv`

### 3.1. バックエンドモジュール構造

Rustバックエンドは機能別にモジュール化され、保守性と可読性を向上させている。

#### 3.1.1. モジュール一覧

- **`lib.rs`** （391行） - メインライブラリファイル
  - Tauriコマンドの定義とアプリケーション設定
  - モジュール間の調整とイベント処理
  - アプリケーション起動時の初期化処理

- **`types.rs`** （71行） - 型定義モジュール
  - `VideoFile` - 動画ファイル情報の構造体
  - `AppSettings` - アプリケーション設定の構造体
  - `ProgressUpdate` - 進捗更新情報の構造体
  - `Gemini*` - Gemini API関連の型定義群

- **`file.rs`** （90行） - ファイル操作モジュール
  - `select_video_files()` - 動画ファイル選択ダイアログ
  - `select_save_directory()` - 保存先ディレクトリ選択ダイアログ
  - `save_document_to_file()` - ドキュメントファイル保存処理

- **`gemini.rs`** （509行） - Gemini API連携モジュール
  - `upload_to_gemini_with_progress()` - 進捗付きファイルアップロード
  - `generate_with_gemini_with_progress()` - 進捗付きドキュメント生成
  - `integrate_documents()` - 複数ドキュメントの統合処理
  - `get_mime_type()` - ファイル形式判定ヘルパー

- **`video.rs`** （213行） - 動画処理モジュール
  - `split_video_if_needed()` - 長時間動画の自動分割（1時間超の場合）
  - `get_video_duration()` - ffprobeによる動画時間取得
  - `check_video_compatibility()` - 動画ファイル互換性チェック
  - `extract_video_info_with_ffprobe()` - 詳細メタデータ抽出
  - `get_video_metadata()` - 基本メタデータ取得
  - `VideoMetadata` - 動画メタデータ構造体

#### 3.1.2. モジュール間の依存関係

```
lib.rs
├── types.rs （型定義を参照）
├── file.rs （ファイル操作を呼び出し）
├── gemini.rs （API処理を呼び出し）
└── video.rs （動画処理を呼び出し）

gemini.rs → types.rs （型定義を参照）
file.rs → types.rs （VideoFile型を参照）
video.rs → 独立モジュール
```

#### 3.1.3. 設計原則

- **単一責任の原則**: 各モジュールは特定の機能領域のみを担当
- **疎結合**: モジュール間の依存を最小限に抑制
- **型安全性**: 共通の型定義により型安全性を確保
- **エラーハンドリング**: anyhow::Resultによる統一的なエラー処理

## 4. 画面構成（案）

- **メイン画面**:
    - ファイル選択エリア（ボタンクリック）
    - 選択されたファイルリスト（ファイル名、ファイルサイズ、削除ボタン）
    - 現在の設定表示（モード、出力言語）
    - ドキュメント生成ボタン
    - 処理進捗表示エリア（プログレスバー、メッセージ、詳細ログ表示/非表示/クリア）
    - 生成結果表示エリア
- **設定画面**:
    - モード選択（マニュアルモード / 仕様書モード）
    - 出力言語選択（日本語 / 英語）
    - APIキー設定欄
    - 保存/キャンセルボタン

## 5. 非機能要件

- **パフォーマンス**: 大容量の動画ファイルでも安定して動作すること。
- **UI/UX**: 直感的で分かりやすいインターフェイスを提供する。
- **セキュリティ**: APIキーは、簡易的なXOR暗号化およびBase64エンコードを施した上で、ローカルの設定ファイル（`settings.json`）に保存される。
